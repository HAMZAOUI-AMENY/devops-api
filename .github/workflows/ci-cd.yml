name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # 1Ô∏è‚É£ Build and Test
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r app/requirements.txt
          pip install pytest flake8

      - name: Run tests
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: pytest tests/

      - name: Lint code
        run: flake8 app/

  # 2Ô∏è‚É£ Docker Build and Push
  docker:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/devops-api:latest .

      - name: Push Docker image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/devops-api:latest

  # 3Ô∏è‚É£ Kubernetes Manifest Validation (No Deployment)
  validate-k8s:
    runs-on: ubuntu-latest
    needs: docker
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install validation tools
        run: |
          pip install pyyaml
          
      - name: Validate YAML syntax
        run: |
          echo "‚úÖ Validating Kubernetes manifests..."
          python3 << 'EOF'
          import yaml
          import sys
          
          files = ['k8s/deployment.yaml', 'k8s/service.yaml']
          
          for file in files:
              print(f'Validating {file}...')
              try:
                  with open(file, 'r') as f:
                      docs = list(yaml.safe_load_all(f))
                      for doc in docs:
                          if doc:
                              # Check required fields
                              assert 'apiVersion' in doc, f'{file}: Missing apiVersion'
                              assert 'kind' in doc, f'{file}: Missing kind'
                              assert 'metadata' in doc, f'{file}: Missing metadata'
                              assert 'name' in doc.get('metadata', {}), f'{file}: Missing metadata.name'
                              print(f'  ‚úì {doc["kind"]}: {doc["metadata"]["name"]}')
              except Exception as e:
                  print(f'‚ùå Error in {file}: {e}')
                  sys.exit(1)
          
          print('\n‚úÖ All Kubernetes manifests are valid!')
          EOF

      - name: Validate with kubeconform
        run: |
          echo "üîç Installing kubeconform..."
          curl -L https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz | tar xz
          chmod +x kubeconform
          
          echo "üîç Validating Kubernetes manifests..."
          ./kubeconform -strict -summary k8s/deployment.yaml k8s/service.yaml
          
          echo "‚úÖ Kubeconform validation passed!"

      - name: Display manifest summary
        run: |
          echo ""
          echo "üìã Kubernetes Resources Summary:"
          echo "================================="
          python3 << 'EOF'
          import yaml
          
          files = ['k8s/deployment.yaml', 'k8s/service.yaml']
          
          for file in files:
              with open(file, 'r') as f:
                  docs = list(yaml.safe_load_all(f))
                  for doc in docs:
                      if doc:
                          kind = doc.get('kind', 'Unknown')
                          name = doc.get('metadata', {}).get('name', 'unnamed')
                          print(f'  ‚Ä¢ {kind}: {name}')
          EOF
          
          echo ""
          echo "‚ÑπÔ∏è  Manifests validated successfully!"
          echo "‚ÑπÔ∏è  Deploy manually to your Minikube cluster using:"
          echo "    kubectl apply -f k8s/"
          echo ""
          echo "üìù Quick deployment:"
          echo "    make deploy"
          echo "    OR"
          echo "    deploy.bat (Windows)"